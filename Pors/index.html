<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پرسشنامه طرح جامع منطقه آزاد دوغارون</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f0f4f8; /* A light blue-gray fallback */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .question-page, #welcome-page {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateY(20px);
        }
        .question-page.active, #welcome-page.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* استایل‌های سفارشی برای کارت‌های سوالات و گزینه‌ها */
        .question-card {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem; /* rounded-2xl */
            padding: 1.5rem; /* p-6 */
            margin-bottom: 2rem; /* mb-8 */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        
        .choice-card {
            display: block;
            padding: 1rem;
            border: 2px solid #e5e7eb; /* gray-200 */
            border-radius: 0.75rem; /* rounded-xl */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: white;
            text-align: center;
        }
        .choice-card:hover {
            border-color: #93c5fd; /* blue-300 */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .choice-card.selected {
            border-color: #2563eb; /* blue-600 */
            background-color: #eff6ff; /* blue-50 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* ring-blue-500 */
        }
        .visually-hidden {
            position: absolute;
            width: 1px; height: 1px;
            padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0);
            white-space: nowrap; border-width: 0;
        }

        /* نوار پیشرفت */
        #progress-container { width: 100%; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; }
        #progress-bar { height: 10px; width: 0%; background-color: #3b82f6; border-radius: 9999px; transition: width 0.4s ease-in-out; }
        
        /* استایل مودال */
        .modal { transition: opacity 0.3s ease; }
        .modal > div { transition: transform 0.3s ease; }
        
        /* استایل جدول */
        .impact-table-grid { display: grid; grid-template-columns: 2fr repeat(5, 1fr); gap: 0.5rem; align-items: center; text-align: center; }
        .impact-table-grid .header { font-weight: bold; padding: 0.5rem; background-color: #f3f4f6; }
        .impact-table-grid .label-cell { text-align: right; padding: 0.5rem; font-weight: 500; }
        .impact-table-grid .radio-cell { display: flex; justify-content: center; align-items: center; }
        
        /* استایل پیام خطا */
        .validation-error { color: #ef4444; font-size: 0.875rem; margin-top: 0.5rem; min-height: 1.25rem; }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto max-w-3xl p-4 sm:p-8 min-h-screen flex flex-col justify-center">
        <div id="form-wrapper">
             <!-- صفحه خوشامدگویی -->
            <div id="welcome-page" class="bg-white rounded-2xl shadow-2xl p-8 text-center active">
                <img src="https://uploadkon.ir/uploads/2b5714_25Screenshot-2025-09-14-134322.png" alt="لوگوی سازمان منطقه آزاد دوغارون" class="mx-auto mb-8 h-28 w-auto">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-4">به پرسشنامه خوش آمدید</h1>
                <p class="text-gray-600 mt-3 text-lg mb-8">
                    از اینکه وقت خود را برای مشارکت در "سنجش دیدگاه ذینفعان طرح جامع منطقه آزاد دوغارون" اختصاص می‌دهید، سپاسگزاریم. نظرات شما برای ما بسیار ارزشمند است.
                </p>
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 text-right space-y-4 mb-8">
                     <p><strong>هدف:</strong> درک دیدگاه‌ها و انتظارات شما از طرح.</p>
                     <p><strong>زمان تقریبی:</strong> پاسخ به سوالات حدود ۱۰ دقیقه زمان خواهد برد.</p>
                     <p><strong>محرمانگی:</strong> تمام اطلاعات شما محرمانه باقی خواهد ماند.</p>
                </div>
                <button type="button" id="startBtn" class="w-full max-w-xs mx-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition transform hover:scale-105 duration-300 text-lg shadow-lg">
                    شروع پرسشنامه
                </button>
            </div>
            
            <!-- کانتینر اصلی فرم -->
            <div class="hidden" id="form-container">
                <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-10">
                    <div class="text-center mb-6">
                        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">پرسشنامه جامع سنجش دیدگاه ذینفعان</h1>
                    </div>
                    <div class="mb-8">
                        <div id="progress-container"><div id="progress-bar"></div></div>
                        <p id="progress-text" class="text-center text-sm text-gray-500 mt-2"></p>
                    </div>
                    
                    <form id="stakeholderForm" novalidate>
                        <!-- محتوای فرم به صورت پویا اینجا قرار می‌گیرد -->
                    </form>
                    
                    <div id="navigation-controls" class="mt-8 flex justify-between items-center">
                        <button type="button" id="prevBtn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">قبلی</button>
                        <button type="button" id="nextBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">بعدی</button>
                    </div>
                    
                    <div class="text-center mt-10 border-t pt-4">
                        <button type="button" id="adminBtn" class="text-xs text-gray-400 hover:text-blue-600">دسترسی مدیر</button>
                        <button type="button" id="exportBtn" class="hidden mt-2 bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700">دریافت خروجی (CSV)</button>
                    </div>
                </div>
            </div>
            
            <div id="final-page" class="hidden text-center p-10 bg-white rounded-2xl shadow-2xl">
                <h2 class="text-2xl font-bold mb-4">از وقتی که گذاشتید سپاسگزاریم!</h2>
                <p class="text-gray-600 mb-8">برای ثبت نهایی پاسخ‌های خود، لطفا دکمه زیر را فشار دهید.</p>
                <button type="submit" form="stakeholderForm" class="w-full max-w-xs mx-auto bg-blue-600 text-white font-bold py-4 px-10 rounded-full hover:bg-blue-700 transition transform hover:scale-105 duration-300 text-lg shadow-lg">ارسال نهایی پاسخ‌ها</button>
            </div>
        </div>
    </div>
    
    <!-- مودال موفقیت -->
    <div id="successModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full text-center transform scale-95">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-5"><svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
            <h3 class="text-2xl font-bold text-gray-800">با تشکر!</h3>
            <p class="text-gray-600 mt-2">پاسخ شما با موفقیت ثبت شد.</p>
            <div class="mt-8 flex justify-center">
                <button id="restartBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 w-full max-w-xs">بازگشت به صفحه نخست</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA4uzrW8zAOagw0S_xmDGb_SSLZfn8afc8",
            authDomain: "dogharoun-a9764.firebaseapp.com",
            projectId: "dogharoun-a9764",
            storageBucket: "dogharoun-a9764.appspot.com",
            messagingSenderId: "873490986773",
            appId: "1:873490986773:web:16871b83bf4c18d4db5b1c"
        };
        
        const questionsData = [
            {
                legend: "مقدمه",
                isIntroduction: true,
                questions: [
                    { id: 'intro_text', type: 'introduction' }
                ]
            },
            {
                legend: "بخش الف: شناسایی و مشخصات ذینفع",
                questions: [
                    { id: 'q1_role', number: 1, text: 'کدام یک از گزینه‌های زیر، نقش یا سازمان شما را به بهترین شکل توصیف می‌کند؟', type: 'radio', options: ['سازمان/نهاد دولتی', 'کسب‌وکار محلی / بخش خصوصی', 'سازمان غیردولتی (NGO) / گروه اجتماعی', 'ساکن محلی', 'نخبه دانشگاهی / کارشناس / مشاور', 'نماینده رسانه'], other: true },
                    { id: 'q2_org_name', number: 2, text: 'لطفاً نام سازمان/اداره خود را (در صورت اطلاق) ذکر کنید.', type: 'text' },
                    { id: 'q3_duration', number: 3, text: 'چه مدت در این منطقه سکونت یا فعالیت داشته‌اید؟', type: 'radio', options: ['کمتر از ۱ سال', '۱ تا ۵ سال', '۶ تا ۱۰ سال', 'بیش از ۱۰ سال'] },
                    { id: 'q4_expertise', number: 4, text: 'لطفاً حوزه اصلی فعالیت یا تخصص خود را به طور خلاصه بیان کنید.', type: 'textarea' }
                ]
            },
            {
                legend: "بخش ب: آگاهی، نگرش و برجستگی طرح",
                questions: [
                    { id: 'q5_familiarity', number: 5, text: 'تا چه حد با اهداف و جزئیات طرح آشنا هستید؟', type: 'scale', labels: ['اصلاً آشنا نیستم', 'بسیار آشنا هستم'] },
                    { id: 'q6_attitude', number: 6, text: 'بر اساس اطلاعات فعلی خود، نگرش اولیه شما نسبت به این طرح چیست؟', type: 'scale', labels: ['بسیار منفی', 'بسیار مثبت'] },
                    { id: 'q7_urgency', number: 7, text: 'به نظر شما، حل مسائلی که این طرح به آنها می‌پردازد، تا چه حد فوریت دارد؟', type: 'scale', labels: ['اصلاً فوری نیست', 'بسیار فوری است'] },
                    { id: 'q8_legitimacy', number: 8, text: 'تا چه اندازه احساس می‌کنید که شما (یا سازمانتان) به طور مشروع و قانونی در نتایج این طرح ذی‌حق و ذی‌نفع هستید؟', type: 'scale', labels: ['هیچ حق مشروعی ندارم', 'حق مشروع بسیار قوی دارم'] }
                ]
            },
            {
                legend: "بخش ج: تحلیل منافع، علایق و اثرات بالقوه",
                questions: [
                    { id: 'q9_impact', number: 9, text: 'لطفاً تأثیر بالقوه این طرح را بر هر یک از حوزه‌های زیر ارزیابی کنید.', type: 'table', headers: ['بسیار منفی', 'منفی', 'بی‌تأثیر', 'مثبت', 'بسیار مثبت'], rows: [
                        { id: 'q9_impact_economic', label: 'اقتصادی' }, { id: 'q9_impact_environmental', label: 'زیست‌محیطی' }, { id: 'q9_impact_social', label: 'اجتماعی' },
                        { id: 'q9_impact_safety', label: 'ایمنی و امنیت' }, { id: 'q9_impact_infrastructure', label: 'زیرساخت' }, { id: 'q9_impact_property', label: 'ارزش املاک' }, { id: 'q9_impact_heritage', label: 'میراث فرهنگی' }
                    ]},
                    { id: 'q10_advantage', number: 10, text: 'مهم‌ترین مزیت یا فرصت بالقوه این طرح چیست؟', type: 'textarea' },
                    { id: 'q11_disadvantage', number: 11, text: 'مهم‌ترین عیب، ریسک یا تهدید بالقوه این طرح چیست؟', type: 'textarea' }
                ]
            },
            {
                legend: "بخش د: سنجش نفوذ و قدرت",
                questions: [
                     { id: 'q12_involvement', number: 12, text: 'آیا نقش یا سازمان شما به طور رسمی در فرآیندهای برنامه‌ریزی یا تصویب دخیل است؟', type: 'radio', options: ['بله', 'خیر', 'نمی‌دانم'] },
                     { id: 'q13_interaction', number: 13, text: 'نقش شما به چه میزانی با تصمیم‌گیرندگان کلیدی تعامل دارد؟', type: 'scale', labels: ['هرگز', 'بسیار زیاد'] },
                     { id: 'q14_control', number: 14, text: 'سازمان شما تا چه حد بر منابع حیاتی برای موفقیت طرح کنترل دارد؟', type: 'scale', labels: ['هیچ کنترلی', 'کنترل قابل توجه'] },
                     { id: 'q15_influencers', number: 15, text: 'کدام گروه‌ها بیشترین نفوذ را در نتیجه نهایی طرح دارند؟', type: 'textarea' }
                ]
            },
            {
                legend: "بخش ه: انتظارات و مشارکت",
                questions: [
                    { id: 'q16_understanding', number: 16, text: 'مهم‌ترین چیزی که تیم پروژه باید از دیدگاه شما درک کند، چیست؟', type: 'textarea' },
                    { id: 'q17_suggestions', number: 17, text: 'چه پیشنهادات مشخصی برای بهبود طرح دارید؟', type: 'textarea' },
                    { id: 'q18_contact_pref', number: 18, text: 'ترجیح می‌دهید از چه طریقی از پیشرفت طرح مطلع شوید؟', type: 'checkbox', options: ['ایمیل', 'جلسات عمومی', 'وب‌سایت', 'شبکه‌های اجتماعی', 'گزارش‌های رسمی'], other: true },
                    { id: 'q19_participation_level', number: 19, text: 'تمایل به چه سطحی از مشارکت در ادامه فرآیند دارید؟', type: 'radio', options: ['دریافت اطلاعات', 'ارائه بازخورد', 'عضویت در کارگروه', 'مشارکت در تصمیم‌گیری', 'عدم تمایل'] },
                    { id: 'q20_followup', number: 20, text: 'آیا تمایل به شرکت در مصاحبه تکمیلی دارید؟', type: 'radio', options: ['بله', 'خیر'] }
                ]
            },
            {
                 legend: "بخش و: اطلاعات جمعیت‌شناختی",
                 questions: [
                    { id: 'q21_age', number: 21, text: 'محدوده سنی خود را مشخص کنید.', type: 'radio', options: ['زیر ۲۵ سال', '۲۵-۳۴', '۳۵-۴۴', '۴۵-۵۴', '۵۵-۶۴', '۶۵+'] },
                    { id: 'q22_gender', number: 22, text: 'جنسیت:', type: 'radio', options: ['زن', 'مرد', 'عدم ذکر'] },
                    { id: 'q23_education', number: 23, text: 'سطح تحصیلات شما چیست؟', type: 'radio', options: ['زیر دیپلم', 'دیپلم', 'کاردانی', 'کارشناسی', 'ارشد', 'دکتری+'] }
                 ]
            },
            {
                legend: "بخش ز: چشم‌انداز آینده",
                questions: [
                    { id: 's4_q24_priority', number: 24, text: 'بالاترین اولویت برای تبدیل شدن دوغارون به هاب لجستیکی چیست؟', type: 'radio', options: ['تکمیل راه‌آهن خواف-هرات', 'مدیریت واحد مرزی', 'هوشمندسازی گمرک', 'جذب سرمایه‌گذاری خارجی', 'توسعه روابط دیپلماتیک'] },
                    { id: 's4_q25_focus', number: 25, text: 'منطقه آزاد باید بر کدام حوزه‌ها (علاوه بر ترانزیت) تمرکز کند؟ (حداکثر ۳ گزینه)', type: 'checkbox', options: ['صنایع تبدیلی', 'تولید صادرات‌محور', 'انرژی‌های تجدیدپذیر', 'خدمات مالی و بیمه', 'گردشگری', 'انبارداری استراتژیک'], limit: 3 },
                    { id: 's4_q26_participation', number: 26, text: 'پیشنهاد شما برای جلب مشارکت مؤثر جامعه محلی و بخش خصوصی چیست؟', type: 'textarea' },
                    { id: 's4_q27_suggestion_board', number: 27, text: 'اگر یک پیشنهاد کلیدی برای هیئت مدیره منطقه آزاد داشتید، چه بود؟', type: 'textarea' },
                    { id: 's4_q28_other', number: 28, text: 'هرگونه نظر یا پیشنهاد دیگری را مرقوم فرمایید.', type: 'textarea' }
                ]
            }
        ];
        
        document.addEventListener('DOMContentLoaded', main);

        function main() {
            const appState = { db: null, auth: null, currentPageIndex: -1, pages: [], isSubmitting: false }; // Start at -1 for welcome page
            const uiElements = {
                form: document.getElementById('stakeholderForm'),
                formContainer: document.getElementById('form-container'),
                formWrapper: document.getElementById('form-wrapper'),
                welcomePage: document.getElementById('welcome-page'),
                startBtn: document.getElementById('startBtn'),
                prevBtn: document.getElementById('prevBtn'),
                nextBtn: document.getElementById('nextBtn'),
                adminBtn: document.getElementById('adminBtn'),
                exportBtn: document.getElementById('exportBtn'),
                finalPage: document.getElementById('final-page'),
                progressText: document.getElementById('progress-text'),
                progressBar: document.getElementById('progress-bar'),
                successModal: document.getElementById('successModal'),
                restartBtn: document.getElementById('restartBtn')
            };
            
            const showConnectionError = (message) => {
                uiElements.formWrapper.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl text-center p-10"><h1 class="text-2xl font-bold text-red-600">${message.title}</h1><p class="text-gray-700 mt-4">${message.body}</p></div>`;
            };
            
            const initializeFirebase = async () => {
                try {
                    if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("YOUR_")) {
                        showConnectionError({ title: "خطا در پیکربندی", body: "اطلاعات اتصال به پایگاه داده (Firebase) به درستی در فایل وارد نشده است." });
                        return false;
                    }
                    const app = initializeApp(firebaseConfig);
                    appState.db = getFirestore(app);
                    appState.auth = getAuth(app);
                    await signInAnonymously(appState.auth);
                    return true;
                } catch (error) {
                    console.error("Firebase Initialization Failed:", error);
                    showConnectionError({ title: "خطا در اتصال به سرور", body: "متاسفانه امکان بارگذاری پرسشنامه وجود ندارد. لطفا اتصال اینترنت خود را بررسی کرده و صفحه را مجدداً بارگذاری نمایید." });
                    return false;
                }
            };

            const buildForm = () => {
                questionsData.forEach(section => {
                    const fieldset = document.createElement('fieldset');
                    fieldset.className = 'question-page';
                    fieldset.innerHTML = `<legend class="text-2xl font-bold text-gray-700 mb-6 text-center">${section.legend}</legend>`;
                    section.questions.forEach(q => {
                        const qDiv = document.createElement('div');
                        if(q.type !== 'introduction') qDiv.className = 'question-card';
                        qDiv.innerHTML = q.number ? `<label class="block text-gray-800 font-semibold mb-4 text-lg" for="${q.id}">${q.number}. ${q.text}</label>` : '';
                        qDiv.appendChild(createInputElement(q));
                        fieldset.appendChild(qDiv);
                    });
                    uiElements.form.appendChild(fieldset);
                    appState.pages.push(fieldset);
                });
            };

            const createInputElement = (q) => {
                const wrapper = document.createElement('div');
                const container = document.createElement('div');
                switch (q.type) {
                    case 'introduction':
                        container.innerHTML = `<div class="bg-blue-50 border-r-4 border-blue-500 p-5 rounded-lg text-justify question-card"><h2 class="font-bold text-xl text-blue-800 mb-2">مقدمه</h2><p class="text-gray-700">با سلام و احترام، این پرسشنامه به منظور شناسایی و درک دیدگاه‌ها، منافع و انتظارات کلیه افراد، گروه‌ها و سازمان‌هایی که تحت تأثیر طرح جامع منطقه آزاد دوغارون قرار می‌گیرند یا بر آن تأثیرگذار هستند، طراحی شده است. مشارکت شما در این نظرسنجی به ما کمک می‌کند تا برنامه‌ریزی دقیق‌تر و فراگیرتری داشته باشیم. اطلاعات شما به صورت محرمانه محفوظ خواهد ماند.</p></div>`;
                        break;
                    case 'text': container.innerHTML = `<input type="text" id="${q.id}" name="${q.id}" class="mt-2 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 bg-white/50">`; break;
                    case 'textarea': container.innerHTML = `<textarea id="${q.id}" name="${q.id}" rows="4" class="mt-2 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 bg-white/50"></textarea>`; break;
                    case 'radio':
                    case 'checkbox':
                        container.className = 'grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4';
                        q.options.forEach(opt => {
                            const optionId = `${q.id}_${opt.replace(/\s+/g, '_')}`;
                            container.innerHTML += `<label for="${optionId}" class="choice-card"><input type="${q.type}" id="${optionId}" name="${q.name || q.id}" value="${opt}" class="visually-hidden"><span class="font-medium text-gray-800">${opt}</span></label>`;
                        });
                        if (q.other) container.innerHTML += `<div class="sm:col-span-2 flex items-center gap-3 p-3 bg-gray-50 rounded-lg border"><label class="font-medium"><input type="${q.type}" name="${q.name || q.id}" value="سایر" class="form-${q.type} ml-2"> سایر:</label><input type="text" name="${q.id}_other" class="flex-grow rounded-md border-gray-300 shadow-sm p-2" placeholder="لطفاً مشخص کنید"></div>`;
                        break;
                    case 'scale': container.innerHTML = `<div class="flex justify-between items-center text-sm text-gray-500 px-1 mt-4"><span>${q.labels[0]}</span><span>${q.labels[1]}</span></div><div class="grid grid-cols-5 gap-2 p-2 bg-gray-100/50 rounded-xl mt-2">${[1,2,3,4,5].map(v => `<label for="${q.id}_${v}" class="choice-card p-3"><input type="radio" name="${q.id}" id="${q.id}_${v}" value="${v}" class="visually-hidden"> <span class="text-lg font-bold">${v}</span></label>`).join('')}</div>`; break;
                    case 'table':
                         container.innerHTML = `<div class="impact-table-grid border border-gray-200 rounded-lg p-3 mt-4 overflow-x-auto bg-white/50"><div class="header label-cell"></div>${q.headers.map((h, i) => `<div class="header text-xs" title="${h}">${i + 1}</div>`).join('')}${q.rows.map(row => `<div class="label-cell border-t">${row.label}</div>${[1,2,3,4,5].map(v => `<div class="radio-cell border-t"><input type="radio" name="${row.id}" value="${v}" class="form-radio"></div>`).join('')}`).join('')}</div>`;
                         break;
                }
                wrapper.appendChild(container);
                if (q.type !== 'introduction') {
                    const errorDiv = document.createElement('div');
                    errorDiv.id = `${q.id}_error`;
                    errorDiv.className = 'validation-error';
                    wrapper.appendChild(errorDiv);
                }
                return wrapper;
            };
            
            const setupChoiceCards = () => {
                uiElements.form.addEventListener('change', e => {
                    if (e.target.matches('input[type="radio"].visually-hidden')) {
                        document.querySelectorAll(`input[name="${e.target.name}"]`).forEach(radio => {
                            radio.parentElement.classList.remove('selected');
                        });
                        e.target.parentElement.classList.add('selected');
                    } else if (e.target.matches('input[type="checkbox"].visually-hidden')) {
                        e.target.parentElement.classList.toggle('selected', e.target.checked);
                    }
                });
            };

            const validateCurrentPage = () => {
                document.querySelectorAll('.validation-error').forEach(el => el.textContent = '');
                if (appState.currentPageIndex < 0) return true; // Welcome page
                let isValid = true;
                const currentSection = questionsData[appState.currentPageIndex];
                if (!currentSection || currentSection.isIntroduction) return true;
                
                currentSection.questions.forEach(q => {
                    const errorEl = document.getElementById(`${q.id}_error`);
                    let questionIsValid = true;
                    switch (q.type) {
                        case 'radio': case 'scale': if (!document.querySelector(`input[name="${q.name || q.id}"]:checked`)) questionIsValid = false; break;
                        case 'checkbox': if (document.querySelectorAll(`input[name="${q.name || q.id}"]:checked`).length === 0) questionIsValid = false; break;
                        case 'textarea': const textarea = document.getElementById(q.id); if (textarea && textarea.value.trim().length < 10) { if(errorEl) errorEl.textContent = 'لطفاً حداقل ۱۰ کاراکتر وارد کنید.'; questionIsValid = false; } break;
                        case 'table': q.rows.forEach(row => { if (!document.querySelector(`input[name="${row.id}"]:checked`)) questionIsValid = false; }); break;
                    }
                    if (!questionIsValid) { isValid = false; if (['radio', 'checkbox', 'scale', 'table'].includes(q.type) && errorEl) { errorEl.textContent = 'پاسخ به این سوال الزامی است.'; } }
                });
                return isValid;
            };

            const updateUI = () => {
                const totalPages = appState.pages.length;
                const isWelcome = appState.currentPageIndex === -1;
                const isFinal = appState.currentPageIndex === totalPages;

                uiElements.welcomePage.classList.toggle('active', isWelcome);
                uiElements.formContainer.classList.toggle('hidden', isWelcome || isFinal);
                uiElements.finalPage.classList.toggle('hidden', !isFinal);

                if (!isWelcome && !isFinal) {
                    appState.pages.forEach((page, index) => page.classList.toggle('active', index === appState.currentPageIndex));
                    
                    const progressPercentage = appState.currentPageIndex > 0 ? ((appState.currentPageIndex) / (totalPages - 1)) * 100 : 0;
                    uiElements.progressBar.style.width = `${progressPercentage}%`;
                    uiElements.progressText.textContent = `صفحه ${appState.currentPageIndex} از ${totalPages - 1}`;
                }

                uiElements.prevBtn.style.visibility = appState.currentPageIndex > 0 ? 'visible' : 'hidden';
                uiElements.nextBtn.textContent = appState.currentPageIndex === totalPages - 1 ? 'پایان و مشاهده فرم' : 'بعدی';
            };
            
            const setupEventListeners = () => {
                uiElements.startBtn.addEventListener('click', () => {
                    appState.currentPageIndex = 0; // Move to introduction page
                    updateUI();
                });

                uiElements.nextBtn.addEventListener('click', () => { if (validateCurrentPage()) { if (appState.currentPageIndex < appState.pages.length) { appState.currentPageIndex++; updateUI(); } } });
                uiElements.prevBtn.addEventListener('click', () => { if (appState.currentPageIndex > 0) { appState.currentPageIndex--; updateUI(); } });
                uiElements.adminBtn.addEventListener('click', () => { const code = prompt('کد مدیر:'); if (code === '212') { uiElements.exportBtn.classList.remove('hidden'); alert('دسترسی مدیر فعال شد.'); } else { alert('کد اشتباه است.'); } });
                uiElements.exportBtn.addEventListener('click', handleExport);
                uiElements.form.addEventListener('submit', handleSubmit);
                uiElements.restartBtn.addEventListener('click', () => { uiElements.successModal.classList.add('opacity-0', 'pointer-events-none'); setTimeout(() => location.reload(), 300); });
            };

            const handleSubmit = async (e) => { e.preventDefault(); if (appState.isSubmitting) return; appState.isSubmitting = true; const btn = e.submitter; btn.disabled = true; btn.textContent = 'در حال ارسال...'; const data = new FormData(uiElements.form); const sub = {}; for (const [key, val] of data.entries()) { if (document.querySelector(`[name="${key}"][type="checkbox"]`)) { if (!sub[key]) sub[key] = []; sub[key].push(val); } else { sub[key] = val; } } Object.keys(sub).forEach(key => { if (Array.isArray(sub[key])) sub[key] = sub[key].join(' | '); }); try { await addDoc(collection(appState.db, "submissions"), sub); uiElements.successModal.classList.remove('opacity-0', 'pointer-events-none'); uiElements.successModal.querySelector('div').classList.add('scale-100'); } catch (err) { console.error("Error: ", err); alert("خطا در ثبت اطلاعات."); } finally { appState.isSubmitting = false; btn.disabled = false; btn.textContent = 'ارسال نهایی پاسخ‌ها'; } };
            const handleExport = async () => { uiElements.exportBtn.disabled = true; uiElements.exportBtn.textContent = 'در حال آماده‌سازی...'; try { const snap = await getDocs(collection(appState.db, "submissions")); const subs = snap.docs.map(doc => doc.data()); if (subs.length === 0) { alert('پاسخی برای خروجی گرفتن ثبت نشده.'); return; } const headers = [...new Set(subs.flatMap(Object.keys))]; let csv = '\uFEFF' + headers.join(',') + '\r\n'; subs.forEach(s => { const row = headers.map(h => `"${String(s[h] || '').replace(/"/g, '""')}"`); csv += row.join(',') + '\r\n'; }); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'dogharoon_data.csv'; document.body.appendChild(link); link.click(); document.body.removeChild(link); } catch (err) { console.error("Error: ", err); alert("خطا در دریافت اطلاعات."); } finally { uiElements.exportBtn.disabled = false; uiElements.exportBtn.textContent = 'دریافت خروجی (CSV)'; } };
            
            (async () => { if (await initializeFirebase()) { buildForm(); setupEventListeners(); setupChoiceCards(); updateUI(); } })();
        }
    </script>
</body>
</html>

